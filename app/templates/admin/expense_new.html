{% extends "admin/base.html" %}
{% block title %}Add Expense{% endblock %}
{% block header %}Record Expense{% endblock %}

{% block page_subtitle %}
  <p class="muted">Capture operating costs with optional template, category, and asset link.</p>
{% endblock %}

{% block page_actions %}
  <a class="btn" href="{{ url_for('admin.dashboard_finance') }}">← Back</a>
  <a class="btn" href="{{ url_for('admin.expense_categories_list') }}">Categories</a>
  <a class="btn" href="{{ url_for('admin.expense_templates_list') }}">Templates</a>
{% endblock %}

{% block content %}
  <style>
    .panel{
      background: var(--card, #fff);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 10px 20px rgba(0,0,0,.03);
      overflow:hidden;
    }
    .panel-head{
      padding:12px 14px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0));
    }
    .panel-title{
      margin:0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .panel-subtitle{
      margin-top:4px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .form{
      padding:12px 14px;
      display:grid;
      gap:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      align-items:end;
    }

    .field{
      grid-column: span 12;
      min-width: 0;
    }

    .field label{
      display:block;
      font-size:12px;
      font-weight:900;
      color: var(--muted);
      margin-bottom:6px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      padding:12px 14px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,.01);
    }

    @media (min-width: 860px){
      .span-6{ grid-column: span 6; }
      .span-5{ grid-column: span 5; }
      .span-4{ grid-column: span 4; }
      .span-3{ grid-column: span 3; }
      .span-2{ grid-column: span 2; }
      .span-8{ grid-column: span 8; }
      .span-7{ grid-column: span 7; }
    }
  </style>

  <section class="panel">
    <div class="panel-head">
      <h3 class="panel-title">New Expense</h3>
      <div class="panel-subtitle">
        <span>Template can auto-fill category + amount (if defined)</span>
      </div>
    </div>

    <form method="post" action="{{ url_for('admin.expense_create') }}">
      <div class="form">
        <div class="grid">

          <div class="field span-6">
            <label>Template (optional)</label>
            <select class="input" name="template_id" id="template_id">
              <option value="">— None —</option>
              {% for t in templates %}
                <option value="{{ t.id }}" data-category="{{ t.category_id }}" data-amount="{{ t.default_amount or '' }}">
                  {{ t.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="field span-6">
            <label>Category (optional)</label>
            <select class="input" name="category_id" id="category_id">
              <option value="">— None —</option>
              {% for c in categories %}
                <option value="{{ c.id }}">
                  {% if c.parent %}{{ c.parent.name }} → {% endif %}{{ c.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="field span-3">
            <label>Amount (KES)</label>
            <input class="input" name="amount" id="amount" required placeholder="e.g. 1500" />
          </div>

          <div class="field span-5">
            <label>Description</label>
            <input class="input" name="description" placeholder="optional details (e.g. KPLC tokens, transport, repair)" />
          </div>

          <div class="field span-4">
            <label>Asset (optional)</label>
            <select class="input" name="asset_id">
              <option value="">— None —</option>
              {% for a in assets %}
                <option value="{{ a.id }}">
                  {{ a.asset_type }} | {{ a.brand or '' }} {{ a.model or '' }} | {{ a.serial_number or ('#' ~ a.id) }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="field span-4">
            <label>Incurred At (optional)</label>
            <input class="input" type="datetime-local" name="incurred_at" />
          </div>

        </div>
      </div>

      <div class="actions">
        <a class="btn" href="{{ url_for('admin.dashboard_finance') }}">Cancel</a>
        <button class="btn primary" type="submit">Save Expense</button>
      </div>
    </form>
  </section>

  <script>
    // If a template is picked, auto-fill category + amount (if default exists)
    const tpl = document.getElementById("template_id");
    const cat = document.getElementById("category_id");
    const amt = document.getElementById("amount");

    tpl?.addEventListener("change", () => {
      const opt = tpl.options[tpl.selectedIndex];
      const categoryId = opt?.dataset?.category || "";
      const defaultAmount = opt?.dataset?.amount || "";

      if (categoryId) cat.value = categoryId;
      if (defaultAmount) amt.value = defaultAmount;
    });
  </script>
{% endblock %}
