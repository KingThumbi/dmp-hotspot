{# app/templates/admin/base.html #}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Admin{% endblock %} · Dmpolin Connect</title>

  <style>
    :root{
      --navy:#000080;
      --gold:#ffd700;

      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#101828;
      --muted:#667085;
      --border:#e5e7eb;

      --shadow: 0 10px 25px rgba(16, 24, 40, 0.08);
      --shadow-sm: 0 2px 10px rgba(16, 24, 40, 0.06);

      --radius: 16px;
      --radius-sm: 12px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }

    a{ color:inherit; text-decoration:none; }
    .muted{ color: var(--muted); }

    /* Top bar */
    .topbar{
      position: sticky;
      top:0;
      z-index: 50;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .topbar-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }

    .logo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--navy), #1a1aa8);
      box-shadow: var(--shadow-sm);
      display:flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(0,0,128,0.12);
      color: var(--gold);
      font-weight: 900;
      letter-spacing: .5px;
    }

    .brand h1{
      margin:0;
      font-size: 14px;
      line-height: 1.2;
      font-weight: 900;
    }
    .brand .sub{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }

    .rightbox{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .badge{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      max-width: min(520px, 80vw);
    }

    .avatar{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: rgba(0,0,128,0.08);
      border: 1px solid rgba(0,0,128,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: var(--navy);
      flex: 0 0 auto;
    }

    .badge .who{
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .badge .who .line1{
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 360px;
    }
    .badge .who .line2{
      font-size: 11px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
    }

    .pill-role{
      border-color: rgba(0,0,128,0.18);
      background: rgba(0,0,128,0.06);
      color: var(--navy);
    }

    .pill-super{
      border-color: rgba(255,215,0,0.45);
      background: rgba(255,215,0,0.25);
      color: #6b4f00;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow-sm);
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
      user-select:none;
    }

    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(0,0,128,0.25);
      box-shadow: 0 12px 28px rgba(16, 24, 40, 0.10);
    }

    .btn-primary{
      border-color: rgba(0,0,128,0.2);
      background: linear-gradient(135deg, rgba(0,0,128,0.08), rgba(255,215,0,0.18));
      color: var(--navy);
    }

    /* Layout */
    .shell{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 30px 16px;
      display:grid;
      grid-template-columns: 260px 1fr;
      gap: 16px;
    }

    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    /* Sidebar */
    .sidebar{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 12px;
      height: fit-content;
    }

    .navsection{
      margin: 6px 0 14px 0;
    }
    .navtitle{
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing: .06em;
      text-transform: uppercase;
      padding: 8px 10px;
    }

    .navlink{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 13px;
      color: var(--text);
      transition: background .15s ease, transform .06s ease;
    }

    .navlink:hover{
      background: rgba(0,0,128,0.06);
      transform: translateY(-1px);
    }

    .navmeta{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }

    .lock{
      font-size: 11px;
      font-weight: 900;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #f1d36b;
      background: #fff7cc;
      color: #7a5b00;
    }

    .active{
      background: rgba(0,0,128,0.08);
      border: 1px solid rgba(0,0,128,0.14);
    }

    /* Main */
    .main{
      min-width: 0;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .pagehead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    .pagehead h2{
      margin:0;
      font-size: 18px;
      font-weight: 950;
    }
    .pagehead p{
      margin: 4px 0 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    /* Flash messages */
    .flashwrap{ margin-bottom: 12px; }
    .flash{
      border-radius: 14px;
      padding: 12px 12px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow-sm);
      font-weight: 800;
      font-size: 13px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .flash.ok{ border-color: rgba(16,185,129,0.25); background: rgba(16,185,129,0.08); }
    .flash.err{ border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.08); }
    .flash.warn{ border-color: rgba(245,158,11,0.30); background: rgba(245,158,11,0.10); }

    /* Small helper links */
    .minirow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .footer{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
    }
  </style>
</head>

<body>
  {# -------------------------------------------------------
     Auth context
     - me is None for anonymous (login/pay pages)
     - NEVER call me.* unless guarded by "me and ..."
     ------------------------------------------------------- #}
  {% set me = current_user if (current_user and current_user.is_authenticated) else None %}
  {% set is_admin = (me and (me.role == "admin" or me.is_superadmin)) %}
  {% set role_label = (me.role if (me and me.role) else "admin") %}

  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">DC</div>
        <div>
          <h1>Dmpolin Connect</h1>
          <p class="sub">Admin Portal</p>
        </div>
      </div>

      <div class="rightbox">
        {% if me %}
          <div class="badge" title="{{ me.email }}">
            <div class="avatar">
              {{ (me.name or me.email or "U")[0:1]|upper }}
            </div>
            <div class="who">
              <div class="line1">{{ me.name or me.email }}</div>
              <div class="line2">
                <span class="pill pill-role">{{ role_label }}</span>
                {% if me.is_superadmin %}
                  <span class="pill pill-super">superadmin</span>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="minirow">
            <a class="btn btn-primary" href="{{ url_for('admin.account_password_get') }}">Change password</a>
            <a class="btn" href="{{ url_for('admin.logout') }}">Logout</a>
          </div>
        {% endif %}
      </div>
    </div>
  </header>

  <div class="shell">
    <aside class="sidebar">

      {# Sidebar nav only makes sense when logged in #}
      {% if me %}

        <div class="navsection">
          <div class="navtitle">Overview</div>
          <a class="navlink" href="{{ url_for('admin.dashboard') }}">Dashboard</a>
        </div>

        <div class="navsection">
          <div class="navtitle">Support</div>

          {# Customers: Admin + Support #}
          {% if is_admin or me.can_support() %}
            <a class="navlink" href="{{ url_for('admin.customers') }}">
              <span>Customers</span>
            </a>
          {% endif %}

          {# Subscriptions: Admin + Support (read-only) + Ops #}
          {% if is_admin or me.can_support() or me.can_ops() %}
            <a class="navlink" href="{{ url_for('admin.subscriptions') }}">
              <span>Subscriptions</span>
              {% if (not is_admin) and me.can_support() and (not me.can_ops()) %}
                <span class="navmeta"><span class="lock">read-only</span></span>
              {% endif %}
            </a>
          {% endif %}
          
          {# Tickets: Admin + Support + Ops #}
          {% if is_admin or me.can_support() or me.can_ops() %}
            <a class="navlink" href="{{ url_for('admin.tickets') }}">
              <span>Tickets</span>
            </a>
          {% endif %}

        </div>

        <div class="navsection">
          <div class="navtitle">Operations</div>

          {% if is_admin or me.can_ops() %}
            <a class="navlink" href="{{ url_for('admin.assets') }}">
              <span>Assets</span>
            </a>

            <a class="navlink" href="{{ url_for('admin.pppoe_new') }}">
              <span>PPPoE Provisioning</span>
            </a>
          {% endif %}
        </div>

        <div class="navsection">
          <div class="navtitle">Finance</div>

          {% if is_admin or me.can_finance() %}
            <a class="navlink" href="{{ url_for('admin.dashboard_finance') }}">
              <span>Finance Dashboard</span>
            </a>

            <a class="navlink" href="{{ url_for('admin.transactions') }}">
              <span>Transactions</span>
            </a>

            <a class="navlink" href="{{ url_for('admin.expense_new') }}">
              <span>New Expense</span>
            </a>

            <a class="navlink" href="{{ url_for('admin.expense_categories_list') }}">
              <span>Expense Categories</span>
            </a>

            <a class="navlink" href="{{ url_for('admin.expense_templates_list') }}">
              <span>Expense Templates</span>
            </a>
          {% endif %}
        </div>

        <div class="navsection">
          <div class="navtitle">Administration</div>
          {# Only show if the route actually exists (prevents BuildError) #}
          {% if is_admin %}
              <a class="navlink" href="{{ url_for('admin.users_list') }}">
              <span>Users</span></a>
          {% endif %}
        </div>

        <div class="footer">
          <div><strong class="muted">Time policy:</strong> DB UTC · UI EAT</div>
        </div>

      {% else %}
        <div class="footer">
          <div><strong class="muted">Dmpolin Connect</strong> · Admin Portal</div>
          <div class="muted" style="margin-top:6px;">Please log in to continue.</div>
        </div>
      {% endif %}
    </aside>

    <main class="main">
      <div class="flashwrap">
        {% with messages = get_flashed_messages(with_categories=True) %}
          {% if messages %}
            {% for category, message in messages %}
              {% set c = category or "ok" %}
              <div class="flash {{ 'ok' if c in ['message','success','ok'] else ('err' if c in ['error','danger','err'] else 'warn') }}">
                <div style="font-weight:950;">
                  {{ '✓' if c in ['message','success','ok'] else ('!' if c in ['warning','warn'] else '×') }}
                </div>
                <div style="flex:1; min-width:0;">{{ message }}</div>
              </div>
              <div style="height:10px;"></div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <section class="card">
        <div class="pagehead">
          <div>
            <h2>{% block page_title %}{% block header %}{% endblock %}{% endblock %}</h2>
            {% block page_subtitle %}{% endblock %}
          </div>
          <div class="minirow">
            {% block page_actions %}{% endblock %}
          </div>
        </div>

        {% block content %}{% endblock %}
      </section>
    </main>
  </div>
</body>
</html>
