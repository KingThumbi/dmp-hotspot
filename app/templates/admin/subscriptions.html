<!-- app/templates/admin/subscriptions.html -->
{% extends "admin/base.html" %}
{% block title %}Subscriptions{% endblock %}

{% block content %}
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:flex-start; gap:12px;">
      <div style="min-width:240px;">
        <h2 style="margin:0;">Subscriptions</h2>
        <div class="muted" style="margin-top:6px;">
          View and manage Hotspot and PPPoE subscriptions.
        </div>
      </div>

      <div class="row" style="gap:10px;">
        {% if svc == "pppoe" %}
          <a class="navlink" href="{{ url_for('admin.pppoe_new') }}">+ New PPPoE</a>
        {% endif %}
      </div>
    </div>

    <hr style="border:none; border-top:1px solid rgba(2,6,23,.08); margin:14px 0;">

    <form method="GET" class="row" style="justify-content:space-between; gap:10px;">
      <div class="row" style="gap:10px; flex:1; min-width:260px;">
        <input
          name="q"
          value="{{ q }}"
          placeholder="Search phone / D### / DA#### ..."
          style="flex:1; min-width:220px;"
        />

        <select name="svc" style="min-width:160px;">
          <option value="">All services</option>
          <option value="hotspot" {% if svc=='hotspot' %}selected{% endif %}>hotspot</option>
          <option value="pppoe" {% if svc=='pppoe' %}selected{% endif %}>pppoe</option>
        </select>

        <select name="pkg" style="min-width:200px;">
          <option value="">All packages</option>
          {% for code in pkg_codes %}
            <option value="{{ code }}" {% if pkg==code %}selected{% endif %}>{{ code }}</option>
          {% endfor %}
        </select>

        <select name="status" style="min-width:160px;">
          <option value="">All status</option>
          <option value="pending" {% if status=='pending' %}selected{% endif %}>pending</option>
          <option value="active" {% if status=='active' %}selected{% endif %}>active</option>
          <option value="expired" {% if status=='expired' %}selected{% endif %}>expired</option>
        </select>
      </div>

      <div class="row" style="gap:10px;">
        <button type="submit">Filter</button>
        <a href="{{ url_for('admin.subscriptions') }}" style="text-decoration:none;">Reset</a>
      </div>
    </form>

    <div class="table-wrap" style="margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th style="width:70px;">ID</th>
            <th style="width:120px;">Service</th>
            <th style="width:190px;">User</th>
            <th style="width:150px;">Package</th>
            <th style="width:120px;">Status</th>
            <th style="width:170px;">Expires</th>
            <th style="width:140px;">Remaining</th>
            <th style="width:90px;">Last Tx</th>
            <th style="width:190px; text-align:right;">Action</th>
          </tr>
        </thead>

        <tbody>
          {% for it in items %}
            {% set s = it.s %}
            {% set svc_type = (s.service_type or "")|lower %}
            {% set username = it.identity or s.router_username or "-" %}

            <tr style="{% if it.is_expired %}background:#fff5f5;{% endif %}">
              <td class="muted">{{ s.id }}</td>

              <td class="muted">
                <span class="pill">{{ svc_type or "-" }}</span>
              </td>

              <td>
                <strong class="truncate" style="max-width:170px;" title="{{ username }}">{{ username }}</strong>
                {% if svc_type == "hotspot" and s.hotspot_username %}
                  <div class="muted" style="font-size:12px; margin-top:3px;">phone</div>
                {% elif svc_type == "pppoe" and s.pppoe_username %}
                  <div class="muted" style="font-size:12px; margin-top:3px;">pppoe</div>
                {% endif %}
              </td>

              <td>
                {% if s.package %}
                  <span class="truncate" title="{{ s.package.name }}">{{ s.package.code }}</span>
                {% else %}
                  {{ s.package_id }}
                {% endif %}
              </td>

              <td>
                {% set st = (s.status or "")|lower %}
                <span class="pill {% if st=='success' %}success{% elif st=='pending' %}pending{% elif st=='failed' %}failed{% endif %}">
                  {{ st or "-" }}
                </span>
              </td>

              <td class="muted">
                {% if s.expires_at %}
                  <span class="truncate" title="{{ s.expires_at }}">{{ s.expires_at }}</span>
                {% else %}
                  -
                {% endif %}
              </td>

              <td>
                {% if it.remaining == "Expired" %}
                  <span class="pill failed">Expired</span>
                {% else %}
                  <span class="pill">{{ it.remaining }}</span>
                {% endif %}
              </td>

              <td class="muted">{{ s.last_tx_id or "-" }}</td>

              <td style="text-align:right;">
                {% if s.status == "active" and s.expires_at and not it.is_expired %}
                  <form method="POST"
                        action="{{ url_for('admin.subscription_enable', sub_id=s.id) }}"
                        style="display:inline;">
                    <button type="submit">Enable on Router</button>
                  </form>
                {% else %}
                  <span class="muted">â€”</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="9" class="muted">No subscriptions found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if svc == "pppoe" %}
      <div class="muted" style="margin-top:12px; font-size:12px;">
        Tip: Use <b>+ New PPPoE</b> to create a PPPoE subscription, then <b>Enable on Router</b> if router automation is enabled.
      </div>
    {% endif %}
  </div>
{% endblock %}
