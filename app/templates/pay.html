{# app/templates/pay.html #}
{% extends "admin/base.html" %}

{% block title %}Pay{% endblock %}

{% block header %}Hotspot Payment{% endblock %}

{% block page_subtitle %}
  <p>Enter your phone number, select a package, then tap Pay.</p>
{% endblock %}

{% block content %}
  <style>
    /* =========================================================
       Layout + Utilities
       ========================================================= */
    .page { padding-bottom: 96px; } /* room for sticky bar on mobile */

    .hr {
      border: none;
      border-top: 1px solid rgba(2,6,23,.08);
      margin: 14px 0;
    }

    /* override base .btn for this page only (scoped by .pay-wrap) */
    .pay-wrap .btn {
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(2,6,23,.10);
      box-shadow: none;
      padding: 10px 14px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select: none;
    }

    .pay-wrap .btn:disabled {
      cursor: not-allowed;
      opacity: .7;
    }

    .pay-wrap .btn--primary {
      background: var(--navy);
      color: #fff;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 18px rgba(0,0,128,.25);
    }

    .pay-wrap .btn--neutral {
      background: #e5e7eb;
      color: #111827;
      border: 1px solid rgba(2,6,23,.10);
      box-shadow: none;
    }

    .pay-wrap .input {
      width: 100%;
      height: 42px;
      border-radius: 12px;
      border: 1px solid rgba(2,6,23,.10);
      padding: 0 12px;
      outline: none;
      font-weight: 800;
      background: #fff;
      color: var(--text);
    }
    .pay-wrap .input:focus {
      border-color: rgba(0,0,128,.35);
      box-shadow: 0 0 0 4px rgba(0,0,128,.08);
    }

    /* =========================================================
       Phone + Pay bar (desktop)
       ========================================================= */
    .paybar{
      display:grid;
      grid-template-columns: 1fr 180px;
      grid-template-rows: auto auto auto;
      gap: 6px 12px;
      align-items: center;
    }
    .paybar label{ grid-column:1; grid-row:1; }
    .paybar input{ grid-column:1; grid-row:2; }
    .paybar .help{ grid-column:1; grid-row:3; }
    .paybar button{ grid-column:2; grid-row:2; height: 42px; }

    @media (max-width: 720px){
      .paybar{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
      }
      .paybar button{
        grid-column:1;
        grid-row:4;
        width:100%;
        height:auto;
      }
      /* Hide the top pay button on phones (keep phone input) */
      #payBtn{ display:none; }
    }

    /* =========================================================
       Packages grid + selection
       ========================================================= */
    .packagesGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      width: 100%;
    }

    .pkg-tile{
      text-align:left;
      background:#fff;
      border: 1px solid rgba(2,6,23,.10);
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      border-radius: 16px;
      padding: 14px;
      color: var(--text);
      width: 100%;
      overflow: hidden;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .pkg-tile:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(2,6,23,.08);
    }
    .pkg-tile.is-selected{
      border-color: rgba(255,215,0,.75);
      box-shadow: 0 14px 26px rgba(255,215,0,.22);
      background: rgba(255,215,0,.16);
      transform: translateY(-1px);
    }

    /* =========================================================
       Result box
       ========================================================= */
    .resultBox{
      border: 1px solid rgba(2,6,23,.10);
      border-radius: 14px;
      padding: 14px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(2,6,23,.06);
    }

    /* =========================================================
       Mobile Sticky Pay Bar
       ========================================================= */
    .stickyPaybar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      display: none; /* shown only on mobile */
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(2,6,23,.10);
      z-index: 999;
    }

    .stickyPaybar__info{ min-width:0; flex:1; }
    .stickyPaybar__label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(2,6,23,.60);
      line-height: 1.1;
    }
    .stickyPaybar__value{
      font-weight: 900;
      color: var(--navy);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 58vw;
      line-height: 1.2;
      margin-top: 2px;
    }

    @media (max-width: 720px){
      .stickyPaybar{ display:flex; }
    }
  </style>

  <div class="pay-wrap page">
    <!-- Phone + Pay -->
    <div class="paybar">
      <label for="phone" class="muted" style="display:block; font-size:13px; font-weight:900;">
        Phone Number
      </label>

      <input
        id="phone"
        class="input"
        placeholder="0712345678"
        inputmode="numeric"
        autocomplete="tel"
        aria-describedby="phoneHelp"
      />

      <div id="phoneHelp" class="help muted" style="font-size:12px;">
        You will receive a payment prompt on this number.
      </div>

      <!-- Desktop Pay button (hidden on mobile) -->
      <button
        id="payBtn"
        type="button"
        class="btn btn--neutral"
        onclick="submitPay()"
        disabled
      >
        Pay
      </button>
    </div>

    <hr class="hr">

    <!-- Packages -->
    <div>
      <div class="muted" style="font-weight:900; margin-bottom:8px;">Select a package</div>

      <div id="packagesGrid" class="packagesGrid">
        {% for p in packages %}
          <button
            type="button"
            class="pkg-tile"
            data-code="{{ p.code }}"
            data-name="{{ p.name }}"
            data-price="{{ p.price_kes }}"
            onclick="selectPackage(this)"
            title="{{ p.name }} — KES {{ p.price_kes }}"
            aria-label="Select {{ p.name }} for KES {{ p.price_kes }}"
          >
            <div style="font-weight:900; color:var(--navy); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
              {{ p.name }}
            </div>

            <div style="margin-top:8px; font-weight:900; font-size:18px; color:#111827; line-height:1.1;">
              KES {{ p.price_kes }}
            </div>

            <div class="muted" style="margin-top:8px; font-size:12px;">
              Tap to select
            </div>
          </button>
        {% else %}
          <div class="muted">No packages available.</div>
        {% endfor %}
      </div>

      <div class="row" style="justify-content:space-between; margin-top:12px; align-items:center; gap:10px;">
        <div class="muted" style="font-size:13px;">
          Selected:
          <span id="selectedLabel" style="font-weight:900; color:var(--navy);">None</span>
        </div>
        <div id="status" class="muted" style="font-weight:900;" aria-live="polite"></div>
      </div>
    </div>

    <!-- Result -->
    <div style="margin-top:14px;">
      <div id="resultBox" class="resultBox">
        <div id="resultTitle" style="font-weight:900; color:var(--navy);">Ready</div>
        <div id="resultMsg" class="muted" style="margin-top:6px;">
          Select a package to continue.
        </div>
        <div id="resultMeta" class="muted" style="margin-top:10px; font-size:13px; display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Mobile sticky Pay bar -->
  <div class="stickyPaybar" role="region" aria-label="Payment actions">
    <div class="stickyPaybar__info">
      <div class="stickyPaybar__label">Selected package</div>
      <div id="stickySelected" class="stickyPaybar__value">None</div>
    </div>

    <button
      id="stickyPayBtn"
      type="button"
      class="btn btn--neutral"
      onclick="submitPay()"
      style="min-width:140px; height:44px;"
      disabled
    >
      Pay
    </button>
  </div>

  <script>
    let selectedPackageCode = null;
    let selectedPackageName = null;
    let selectedPackagePrice = null;
    let isSubmitting = false;

    function setButtonsEnabled(enabled){
      const btn = document.getElementById("payBtn");
      const stickyBtn = document.getElementById("stickyPayBtn");

      const apply = (b) => {
        if(!b) return;
        b.disabled = !enabled;
        b.classList.remove("btn--primary", "btn--neutral");
        b.classList.add(enabled ? "btn--primary" : "btn--neutral");
      };

      apply(btn);
      apply(stickyBtn);
    }

    function setResult(title, msgHtml, metaText, kind){
      const titleEl = document.getElementById("resultTitle");
      const msgEl = document.getElementById("resultMsg");
      const metaEl = document.getElementById("resultMeta");
      const box = document.getElementById("resultBox");

      titleEl.textContent = title;
      msgEl.innerHTML = msgHtml;

      // Reset to neutral
      titleEl.style.color = "var(--navy)";
      box.style.background = "#fff";
      box.style.borderColor = "rgba(2,6,23,.10)";

      // If your base.css defines these, they’ll apply; otherwise it stays neutral.
      if(kind === "success"){
        titleEl.style.color = "var(--success-tx, #166534)";
        box.style.background = "var(--success-bg, rgba(16,185,129,.08))";
        box.style.borderColor = "rgba(22,101,52,.18)";
      }else if(kind === "warning"){
        titleEl.style.color = "var(--warn-tx, #92400e)";
        box.style.background = "var(--warn-bg, rgba(245,158,11,.10))";
        box.style.borderColor = "rgba(146,64,14,.18)";
      }else if(kind === "error"){
        titleEl.style.color = "var(--danger-tx, #7f1d1d)";
        box.style.background = "var(--danger-bg, rgba(239,68,68,.08))";
        box.style.borderColor = "rgba(127,29,29,.18)";
      }

      if(metaText){
        metaEl.style.display = "block";
        metaEl.textContent = metaText;
      }else{
        metaEl.style.display = "none";
        metaEl.textContent = "";
      }
    }

    function normalizePhone(phone){
      const p = (phone || "").replace(/\s+/g, "");
      if(/^07\d{8}$/.test(p)) return "254" + p.slice(1);
      if(/^7\d{8}$/.test(p)) return "254" + p;
      if(/^2547\d{8}$/.test(p)) return p;
      return p;
    }

    function isValidKenyanMobile(phone){
      return /^2547\d{8}$/.test(phone);
    }

    function clearSelectedStyles(){
      document.querySelectorAll(".pkg-tile").forEach(el => el.classList.remove("is-selected"));
    }

    function selectPackage(btn){
      clearSelectedStyles();
      btn.classList.add("is-selected");

      selectedPackageCode = btn.dataset.code;
      selectedPackageName = btn.dataset.name || selectedPackageCode;
      selectedPackagePrice = btn.dataset.price || "";

      const label = selectedPackagePrice
        ? `${selectedPackageName} (KES ${selectedPackagePrice})`
        : selectedPackageName;

      document.getElementById("selectedLabel").textContent = label;

      const stickySelected = document.getElementById("stickySelected");
      if (stickySelected) stickySelected.textContent = label;

      if(!isSubmitting) setButtonsEnabled(true);

      setResult("Selected", `Tap <b>Pay</b> to continue for <b>${label}</b>.`, null, "info");
      document.getElementById("status").textContent = "";
    }

    async function submitPay(){
      if(isSubmitting) return;

      const phoneRaw = document.getElementById("phone").value.trim();
      const phone = normalizePhone(phoneRaw);
      const statusEl = document.getElementById("status");

      if(!phoneRaw){
        statusEl.textContent = "Enter your phone number.";
        setResult("Missing phone", "Please enter your phone number to continue.", null, "error");
        return;
      }

      if(!isValidKenyanMobile(phone)){
        statusEl.textContent = "Invalid phone format.";
        setResult("Invalid phone", "Use <b>0712345678</b> or <b>254712345678</b>.", `Normalized: ${phone}`, "error");
        return;
      }

      if(!selectedPackageCode){
        statusEl.textContent = "Select a package.";
        setResult("Select a package", "Tap a package to continue.", null, "warning");
        return;
      }

      isSubmitting = true;
      setButtonsEnabled(false);

      statusEl.textContent = "Processing…";
      setResult("Processing…", "Sending payment prompt. Please wait…", `Phone: ${phone}`, "info");

      try{
        const r = await fetch("/pay", {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ phone: phone, package: selectedPackageCode })
        });

        const data = await r.json().catch(() => ({}));

        if(r.ok){
          setResult("Prompt Sent", "Check your phone and complete the payment.", null, "success");
          statusEl.textContent = "Prompt sent. Check your phone.";
        }else{
          const msg = data.error || data.message || data.ResultDesc || "Payment request failed. Please try again.";
          setResult("Could not send prompt", msg, null, "error");
          statusEl.textContent = "Failed. Try again.";
        }
      }catch(e){
        setResult("Network error", "Please check your connection and try again.", null, "error");
        statusEl.textContent = "Network error.";
      }finally{
        isSubmitting = false;
        setButtonsEnabled(!!selectedPackageCode);
      }
    }

    // Initial state
    setButtonsEnabled(false);
    const stickySelected = document.getElementById("stickySelected");
    if (stickySelected) stickySelected.textContent = "None";
  </script>
{% endblock %}
