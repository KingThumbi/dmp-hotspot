import re
from datetime import datetime, timedelta
from flask import Blueprint, render_template, request, jsonify
from .extensions import db
from .models import Package, Customer, Subscription, Transaction
from .mpesa import stk_push

portal = Blueprint("portal", __name__)

def normalize_phone(phone: str) -> str:
    # Accept 07..., 7..., +2547..., 2547...
    p = re.sub(r"\s+", "", phone or "")
    p = p.replace("+", "")
    if p.startswith("0") and len(p) == 10:
        return "254" + p[1:]
    if p.startswith("7") and len(p) == 9:
        return "254" + p
    if p.startswith("254") and len(p) == 12:
        return p
    raise ValueError("Invalid phone number. Use 07XXXXXXXX or 2547XXXXXXXX.")

@portal.get("/hotspot")
def hotspot_home():
    packages = Package.query.order_by(Package.price_kes.asc()).all()
    return render_template("hotspot.html", packages=packages)

@portal.post("/pay")
def pay():
    data = request.form or request.json or {}
    phone_raw = data.get("phone", "")
    package_code = data.get("package", "")

    try:
        phone = normalize_phone(phone_raw)
    except ValueError as e:
        return jsonify({"ok": False, "error": str(e)}), 400

    pkg = Package.query.filter_by(code=package_code).first()
    if not pkg:
        return jsonify({"ok": False, "error": "Invalid package."}), 400

    # customer
    cust = Customer.query.filter_by(phone=phone).first()
    if not cust:
        cust = Customer(phone=phone)
        db.session.add(cust)
        db.session.flush()

    # transaction record
    tx = Transaction(customer_id=cust.id, package_id=pkg.id, amount=pkg.price_kes, status="pending")
    db.session.add(tx)
    db.session.flush()

    # subscription intent
    sub = Subscription(
        customer_id=cust.id,
        package_id=pkg.id,
        status="pending",
        router_username=phone,
        last_tx_id=tx.id,
    )
    db.session.add(sub)
    db.session.commit()

    # STK push
    try:
        resp = stk_push(portal._get_current_object().app, phone, pkg.price_kes)  # not used
    except Exception:
        # keep pending; admin can view failures
        return jsonify({"ok": False, "error": "Failed to initiate payment. Try again."}), 500

    # Save IDs if present
    tx.checkout_request_id = resp.get("CheckoutRequestID")
    tx.merchant_request_id = resp.get("MerchantRequestID")
    db.session.commit()

    return jsonify({"ok": True, "phone": phone, "checkout_request_id": tx.checkout_request_id})

@portal.get("/status")
def status():
    phone_raw = request.args.get("phone", "")
    try:
        phone = normalize_phone(phone_raw)
    except ValueError as e:
        return jsonify({"ok": False, "error": str(e)}), 400

    cust = Customer.query.filter_by(phone=phone).first()
    if not cust:
        return jsonify({"ok": True, "status": "none"})

    sub = Subscription.query.filter_by(customer_id=cust.id).order_by(Subscription.created_at.desc()).first()
    if not sub:
        return jsonify({"ok": True, "status": "none"})

    payload = {
        "ok": True,
        "status": sub.status,
        "expires_at": sub.expires_at.isoformat() if sub.expires_at else None,
    }
    return jsonify(payload)
